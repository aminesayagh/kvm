name: KVM Setup and Test

on:
  push:
    branches: [main, test]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
              qemu-kvm \
              libvirt-daemon-system \
              libvirt-clients \
              bridge-utils \
              virt-manager \
              wget \
              lsof \
              cpu-checker \
              tree

      - name: Configure libvirt
        run: |
          sudo systemctl start libvirtd
          sudo systemctl enable libvirtd
          sleep 5  # Wait for service to be fully up
          sudo virsh net-start default || true
          sudo virsh net-autostart default || true

      - name: Create required directories
        run: |
          sudo mkdir -p /var/lib/libvirt/images
          sudo chmod 777 /var/lib/libvirt/images
          mkdir -p logs dist

      - name: Download Debian ISO
        run: |
          chmod +x download.sh
          sudo ./download.sh

      - name: Run healthcheck
        run: |
          chmod +x setup_kvm.sh download.sh cleanup.sh
          chmod +x scripts/*.sh
          sudo ./setup_kvm.sh
        env:
          DEBIAN_FRONTEND: noninteractive # Disable interactive prompts during installation

